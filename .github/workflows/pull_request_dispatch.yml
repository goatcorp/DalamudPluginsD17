name: PR Checks Dispatch
on:
  repository_dispatch:
    types: [start-pr-checks]

permissions:
  issues: write
  pull-requests: write
  contents: write

jobs:
  run-plogon:
    name: Build Plugins
    runs-on: ubuntu-latest
    steps:
    - uses: LouisBrunner/checks-action@v1.2.0
      id: register_check
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        name: Build PR
        sha: ${{ github.event.client_payload.ref }}
        status: in_progress
    
    - name: Checkout manifests
      uses: actions/checkout@v3
      with:
        repository: goatcorp/DalamudPluginsD17
        path: manifests
        ref: ${{ github.event.client_payload.ref }}

    - name: Checkout Plogon
      uses: actions/checkout@v3
      with:
        repository: goatcorp/Plogon
        #ref: V1.0.6
        path: Plogon

    - name: Create required folders
      run: |
        mkdir output
        mkdir artifacts
        mkdir static
        mkdir work

    - name: Run Plogon
      working-directory: Plogon/Plogon
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        PR_ACTOR: ${{ github.event.client_payload.actor }}
        GITHUB_PR_NUM: ${{ github.event.client_payload.prnum }}
      run: |
        dotnet run -- \
        --manifest-folder="${{ github.workspace }}/manifests" \
        --output-folder="${{ github.workspace }}/output" \
        --work-folder="${{ github.workspace }}/work" \
        --static-folder="${{ github.workspace }}/Plogon/Plogon/static" \
        --artifact-folder="${{ github.workspace }}/artifacts" \
        --ci
      
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: plugin-artifact
        path: artifacts
        
    - uses: LouisBrunner/checks-action@v1.2.0
      if: always()
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        check_id: ${{ steps.register_check.outputs.check_id }}
        conclusion: ${{ job.status }}
